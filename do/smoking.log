
. 
. 
. ssc install synth, replace
checking synth consistency and verifying not already installed...
all files already exist and are up to date.

. 
. * Estimation 1: Texas model of black male prisoners (per capita)
. use ../data/smoking.dta, replace
(Tobacco Sales in 39 US States)

. 
. tsset state year
       panel variable:  state (strongly balanced)
        time variable:  year, 1970 to 2000
                delta:  1 unit

. 
. #delimit;
delimiter now ;
. synth   cigsale
>                 cigsale(1988) cigsale(1980) cigsale(1975)
>                 beer(1984(1)1988) lnincome age15to24 retprice
>                 ,               
>                 trunit(3) trperiod(1988)
>                 mspeperiod(1970(1)1988) resultsperiod(1970(1)2000) 
>                 keep(../data/synth/synth_bmprate.dta) replace fig;
--------------------------------------------------------------------------------
Synthetic Control Method for Comparative Case Studies
--------------------------------------------------------------------------------

First Step: Data Setup
--------------------------------------------------------------------------------
control units: for 38 of out 38 units missing obs for predictor lnincome in peri
> od 1970 -ignored for averaging
control units: for 38 of out 38 units missing obs for predictor lnincome in peri
> od 1971 -ignored for averaging
treated unit: for 1 of out 1 units missing obs for predictor lnincome in period 
> 1970 -ignored for averaging
treated unit: for 1 of out 1 units missing obs for predictor lnincome in period 
> 1971 -ignored for averaging
--------------------------------------------------------------------------------
Data Setup successful
--------------------------------------------------------------------------------
                Treated Unit: California
               Control Units: Alabama, Arkansas, Colorado, Connecticut,
                              Delaware, Georgia, Idaho, Illinois, Indiana, Iowa,
                              Kansas, Kentucky, Louisiana, Maine, Minnesota,
                              Mississippi, Missouri, Montana, Nebraska, Nevada,
                              New Hampshire, New Mexico, North Carolina, North
                              Dakota, Ohio, Oklahoma, Pennsylvania, Rhode
                              Island, South Carolina, South Dakota, Tennessee,
                              Texas, Utah, Vermont, Virginia, West Virginia,
                              Wisconsin, Wyoming
--------------------------------------------------------------------------------
          Dependent Variable: cigsale
  MSPE minimized for periods: 1970 1971 1972 1973 1974 1975 1976 1977 1978 1979
                              1980 1981 1982 1983 1984 1985 1986 1987 1988
Results obtained for periods: 1970 1971 1972 1973 1974 1975 1976 1977 1978 1979
                              1980 1981 1982 1983 1984 1985 1986 1987 1988 1989
                              1990 1991 1992 1993 1994 1995 1996 1997 1998 1999
                              2000
--------------------------------------------------------------------------------
                  Predictors: cigsale(1988) cigsale(1980) cigsale(1975)
                              beer(1984(1)1988) lnincome age15to24 retprice
--------------------------------------------------------------------------------
Unless period is specified
predictors are averaged over: 1970 1971 1972 1973 1974 1975 1976 1977 1978 1979
                              1980 1981 1982 1983 1984 1985 1986 1987
--------------------------------------------------------------------------------

Second Step: Run Optimization
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
Optimization done
--------------------------------------------------------------------------------

Third Step: Obtain Results
--------------------------------------------------------------------------------
Loss: Root Mean Squared Prediction Error

---------------------
   RMSPE |  1.939731 
---------------------
--------------------------------------------------------------------------------
Unit Weights:

----------------------------
         Co_No | Unit_Weight
---------------+------------
       Alabama |           0
      Arkansas |           0
      Colorado |        .265
   Connecticut |        .111
      Delaware |           0
       Georgia |           0
         Idaho |           0
      Illinois |           0
       Indiana |           0
          Iowa |           0
        Kansas |           0
      Kentucky |           0
     Louisiana |           0
         Maine |           0
     Minnesota |           0
   Mississippi |           0
      Missouri |           0
       Montana |           0
      Nebraska |           0
        Nevada |        .251
 New Hampshire |           0
    New Mexico |           0
North Carolina |           0
  North Dakota |           0
          Ohio |           0
      Oklahoma |           0
  Pennsylvania |           0
  Rhode Island |           0
South Carolina |           0
  South Dakota |           0
     Tennessee |           0
         Texas |           0
          Utah |        .374
       Vermont |           0
      Virginia |           0
 West Virginia |           0
     Wisconsin |           0
       Wyoming |           0
----------------------------
--------------------------------------------------------------------------------
Predictor Balance:

------------------------------------------------------
                               |   Treated  Synthetic 
-------------------------------+----------------------
                 cigsale(1988) |      90.1    92.8887 
                 cigsale(1980) |     120.2   120.3909 
                 cigsale(1975) |     127.1   126.8016 
             beer(1984(1)1988) |     24.28   23.22006 
                      lnincome |  10.02489   9.871835 
                     age15to24 |  .1798367   .1839628 
                      retprice |  63.81667   62.48484 
------------------------------------------------------
--------------------------------------------------------------------------------

.                 mat list e(V_matrix);

symmetric e(V_matrix)[7,7]
               cigsale(1988)  cigsale(1980)  cigsale(1975)   beer(1~1988)
cigsale(1988)      .06626532
cigsale(1980)              0      .38705996
cigsale(1975)              0              0      .53962531
 beer(1~1988)              0              0              0      .00182017
     lnincome              0              0              0              0
    age15to24              0              0              0              0
     retprice              0              0              0              0

                    lnincome      age15to24       retprice
     lnincome      .00176704
    age15to24              0      .00025756
     retprice              0              0      .00320464

.                 * (1) in line 30 means show each year
> 
> #delimit cr
> 
> graph save Graph ../figures/synth_tx.gph, replace
> 
> 
> * Plot the gap in predicted error
> use ../data/synth/synth_bmprate.dta, clear
> keep _Y_treated _Y_synthetic _time
> drop if _time==.
> rename _time year
> rename _Y_treated  treat
> rename _Y_synthetic counterfact
> gen gap39=treat-counterfact
> sort year 
> twoway (line gap39 year,lp(solid)lw(vthin)lcolor(black)), yline(0, lpattern(sh
> ortdash) lcolor(black)) xline(1988, lpattern(shortdash) lcolor(black)) xtitle(
> "",si(medsmall)) xlabel(#10) ytitle("Gap in  prediction error", size(medsmall)
> ) legend(off)
> save ../data/synth/synth_bmprate_48.dta, replace
> 
> 
> * Inference 1 placebo test
> #delimit;
. set more off;

. use ../data/smoking.dta, replace;
(Tobacco Sales in 39 US States)

. local statelist  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 2
> 4 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39;

. foreach i of local statelist {;
  2. synth   cigsale
>                 cigsale(1988) cigsale(1980) cigsale(1975)
>                 beer(1984(1)1988) lnincome age15to24 retprice
>                 ,               
>                         trunit(`i') trperiod(1988)
>                         mspeperiod(1970(1)1988) resultsperiod(1970(1)2000)
>                         keep(../data/synth/synth_bmprate_`i'.dta) replace;
  3.                         matrix state`i' = e(RMSPE);
  4.  /* check the V matrix*/
>                         };
variable index not found
r(111);

end of do-file

r(111);

. do "/var/folders/st/xzrptnmx0lb7r93b976p0jc40000gn/T//SD00614.000000"

. * Plot the gap in predicted error
. use ../data/synth/synth_bmprate.dta, clear
(Tobacco Sales in 39 US States)

. keep _Y_treated _Y_synthetic _time

. drop if _time==.
(7 observations deleted)

. rename _time year

. rename _Y_treated  treat

. rename _Y_synthetic counterfact

. gen gap39=treat-counterfact

. sort year 

. twoway (line gap39 year,lp(solid)lw(vthin)lcolor(black)), yline(0, lpattern(sh
> ortdash) lcolor(black)) xline(1988, lpattern(shortdash) lcolor(black)) xtitle(
> "",si(medsmall)) xlabel(#10) ytitle("Gap in  prediction error", size(medsmall)
> ) legend(off)

. save ../data/synth/synth_bmprate_39.dta, replace
(note: file ../data/synth/synth_bmprate_39.dta not found)
file ../data/synth/synth_bmprate_39.dta saved

. 
end of do-file

